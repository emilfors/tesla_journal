<html>
    <head>
        <meta http-equiv=Content-Type content="text/html" charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Tesla Körjournal</title>

        <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.form/4.3.0/jquery.form.min.js" integrity="sha384-qlmct0AOBiA2VPZkMY3+2WqkHtIQ9lSdAsAn5RUJD/3vA5MKDgSGcdmIv4ycVxyn" crossorigin="anonymous"></script>

        <style>
body {
    margin: 0;
    font-family: Arial, Helvetica, sans-serif;
}

.header {
    padding: 20px 0px;
    background: #ffffff;
}

.content {
    padding: 0px;
}

.sticky {
    position: fixed;
    top: 0;
    width: 100%
}

.sticky + .content {
    padding-top: 250px;
}

.day {
    background-color: #fafaff;
    border: solid black 2px;
    -moz-border-radius: 8px;
    -webkit-border-radius: 8px;
    border-radius: 8px;
    padding: 20px;
}
.date {
    font-weight: bold;
}

.totals {
    font-size: 12pt;
}

.weekend {
    background-color: #fffafa;
}

.business {
    color: #2196f3;
    font-size: 10.0pt;
}

.private {
    color: #ff9800;
    font-size: 10.0pt;
}

.btn {
    border: 2px solid black;
    border-radius: 5px;
    background-color: white;
    color: black;
    padding: 10px 28px;
    font-size: 12pt;
    cursor: pointer;
    width: 150px;
}

.btn:disabled {
    border-color: #e7e7e7;
    color: black;
    background: #e7e7e7;
}

/* Blue */
.businessClass {
    border-color: #2196F3;
    color: dodgerblue
}

.businessClass:hover:not([disabled]) {
    background: #2196F3;
    color: white;
}

/* Orange */
.privateClass {
    border-color: #ff9800;
    color: orange;
}

.privateClass:hover:not([disabled]) {
    background: #ff9800;
    color: white;
}

/* Green */
.group {
    border-color: #4CAF50;
    color: green;
}

.group:hover:not([disabled]) {
    background-color: #4CAF50;
    color: white;
}

/* Red */
.ungroup {
    border-color: #f44336;
    color: red
}

.ungroup:hover:not([disabled]) {
    background: #f44336;
    color: white;
}
        </style>

        <svg width="0" height="0">
            <!-- Created by Nick Bluth from the Noun Project -->
            <defs>
            <path id="merge" fill-rule="evenodd" fill="gray" d="M13,8 L13,13.1715729 C13,13.9672223 12.6839295,14.7302841 12.1213203,15.2928932 L7.70710678,19.7071068 C7.31658249,20.0976311 6.68341751,20.0976311 6.29289322,19.7071068 C5.90236893,19.3165825 5.90236893,18.6834175 6.29289322,18.2928932 L10.7071068,13.8786797 C10.8946432,13.6911433 11,13.4367894 11,13.1715729 L11,8 L8.37480909,8 C8.20912366,8 8.07480909,7.86568542 8.07480909,7.7 C8.07480909,7.61872484 8.10778542,7.54092765 8.16619251,7.48440983 L11.6523055,4.11106044 C11.8461532,3.92348305 12.1538464,3.92348305 12.3476941,4.11106044 L15.8338071,7.48440983 C15.9528743,7.59962558 15.9559965,7.78954942 15.8407807,7.90861658 C15.7842629,7.96702366 15.7064657,8 15.6251905,8 L13,8 Z M13.2928932,16.7071068 C12.9023689,16.3165825 12.9023689,15.6834175 13.2928932,15.2928932 C13.6834175,14.9023689 14.3165825,14.9023689 14.7071068,15.2928932 L17.7071068,18.2928932 C18.0976311,18.6834175 18.0976311,19.3165825 17.7071068,19.7071068 C17.3165825,20.0976311 16.6834175,20.0976311 16.2928932,19.7071068 L13.2928932,16.7071068 Z"/>
            </defs>
        </svg>

    </head>

    <body>
        <center>
            <div class="header sticky" id="pageHeader">
                <table cellpadding=0 cellspacing=0 width=900 height=200 border=0 dir=ltr>
                    <tr height=100 width=100%>
                        <form id="selectform" action="/" method="post">
                            <td align=left valign=top>
                                <span>
                                    <a href="javascript:reloadPage()" style="font-size: 18.0pt;text-decoration:none;color:black;font-weight:bold;">Tesla Körjournal</a>
                                </span>
                            </td>

                            <td align=right valign=top>
                                {{$y := .Year}}
                                {{$m := .Month}}
                                <select id="month" name="month" onchange="selectform.submit()">
                                    {{range .DropdownMonths}}
                                    <option {{if eq .Number $m}}selected{{end}} value="{{.Number}}">{{.Name}}</option>
                                    {{end}}
                                </select>

                                <select id="year" name="year" onchange="selectform.submit()">
                                    {{range .DropdownYears}}
                                    <option {{if eq . $y}}selected{{end}} value="{{.}}">{{.}}</option>
                                    {{end}}
                                </select>
                            </td>

                            <td align=right valign=top>
                                {{$c := .CarId}}
                                <select id="car" name="car" onchange="selectform.submit()">
                                    {{range .DropdownCars}}
                                    <option {{if eq .Id $c}}selected{{end}} value="{{.Id}}">Tesla Model {{.Model}} ({{.Name}})</option>
                                    {{end}}
                                </select>
                            </td>
                        </form>
                    </tr>

                    <tr valign=bottom>
                        <td align=left>
                            <button disabled id="btn_business" class="btn businessClass">Tjänsteresa</button>
                            <button disabled id="btn_private" class="btn privateClass">Privat resa</button><br>
                            <br>
                            <button disabled id="btn_group" class="btn group">Gruppera</button>
                            <button disabled id="btn_ungroup" class="btn ungroup">Avgruppera</button>
                        </td>

                        <td align=right>
                            <span id="totaldistances" class="totals">
                            Total körsträcka: {{.TotalDistanceString}} km<br>
                            Varav tjänsteresor: {{.TotalBusinessDistanceString}} km<br>
                            Varav privatresor: {{.TotalPrivateDistanceString}} km
                            {{if .UnclassifiedDrivesRemaining }}<br>
                            <font color="red">Oklassificerad sträcka: {{.UnclassifiedDistanceString}} km</font>
                            </span>
                            {{end}}
                        </td>

                        <td align=right>
                            <span id="totaldurations" class="totals">
                            Total tid: {{.TotalDurationString}}<br>
                            Varav tjänsteresor: {{.TotalBusinessDurationString}}<br>
                            Varav privatresor: {{.TotalPrivateDurationString}}
                            {{if .UnclassifiedDrivesRemaining }}<br>
                            <font color="red">Oklassificerad tid: {{.UnclassifiedDurationString}}</font>
                            </span>
                            {{end}}
                        </td>
                    </tr>
                </table>
            </div>

            <div class="content">
                <form id="dayform" action="/" method="post">
                    <input type="hidden" id="action" name="action" value="">
                    <input type="hidden" id="classification" name="classification" value="">
                    <input type="hidden" name="year" value="{{$y}}">
                    <input type="hidden" name="month" value="{{$m}}">
                    <input type="hidden" name="car" value="{{$c}}">

                    <table cellpadding=0 cellspacing=0 width=900 border=0 dir=ltr>
                        {{range .Days}}
                        {{$d := .}}
                        <tr>
                            <td colspan=3>
                                <table width=100% class="day{{if .IsWeekend}} weekend{{end}}" id="day_{{.DateAsTs}}">
                                    <tr height=10>
                                        <td align=left width=25>
                                            <input type="checkbox" class="mastercb"/>
                                        </td>

                                        <td width=25>
                                            &nbsp;
                                        </td>

                                        <td align=left colspan=5>
                                            <span class="date">{{.DateString}}</span>
                                        </td>
                                    </tr>

                                    <tr height=10>
                                        <td colspan=7>
                                            &nbsp;
                                        </td>
                                    </tr>

                                    {{$currentGroupId := -1}}
                                    {{range .Drives}}
                                    {{$gid := .GroupIdInt}}
                                    {{if ne $gid -1}}
                                    {{if ne $gid $currentGroupId}}
                                    {{$currentGroupId = .GroupIdInt}}
                                    {{$gd := $d.GetGroupedDrives $currentGroupId}}
                                    <tr>
                                        <td align=left valign=center width=25>
                                            <input type="checkbox" class="drivecb groupedcb" name="groupeddrive" value="{{$currentGroupId}}"/>
                                        </td>

                                        <td align=center valign=center width=25>
                                            <svg width="24" height="30">
                                                <use x="0" y="0" xlink:href="#merge"/>
                                            </svg>
                                        </td>

                                        <td align=left width=250>
                                            <span lang=sv style='font-size: 10.0pt; font-family:Calibri;language:sv'>
                                                {{$gd.EndAddress}}<br>
                                                {{$gd.StartAddress}}
                                            </span>
                                        </td>

                                        <td align=right width=50>
                                            <span lang=sv style='font-size: 10.0pt;font-family:Calibri;language:sv'>
                                                {{$gd.EndTime}}
                                                {{$gd.StartTime}}
                                            </span>
                                        </td>

                                        <td width=150>
                                            &nbsp;
                                        </td>

                                        <td align=left width=250>
                                            <span lang=sv style='font-size: 10.0pt;font-family:Calibri;language:sv'>
                                                Körsträcka: {{$gd.DistanceString}} km<br>
                                                Tid: {{$gd.DurationString}}
                                            </span>
                                        </td>

                                        <td class={{.ClassificationClass}} align=right width=150>
                                            {{$gd.ClassificationString}}
                                        </td>
                                    </tr>

                                    <tr height=10>
                                        <td colspan=7>
                                            &nbsp;
                                        </td>
                                    </tr>
                                    {{end}}
                                    {{end}}
                                    {{if eq .GroupIdInt -1}}
                                    <tr>
                                        <td align=left valign=center width=25>
                                            <input type="checkbox" class="drivecb" name="drive" value="{{.Id}}"/>
                                        </td>

                                        <td width=25>
                                            &nbsp;
                                        </td>

                                        <td align=left width=250>
                                            <span lang=sv style='font-size: 10.0pt; font-family:Calibri;language:sv'>
                                                {{.EndAddress}}<br>
                                                {{.StartAddress}}
                                            </span>
                                        </td>

                                        <td align=right width=50>
                                            <span lang=sv style='font-size: 10.0pt;font-family:Calibri;language:sv'>
                                                {{.EndTime}}<br>
                                                {{.StartTime}}
                                            </span>
                                        </td>

                                        <td width=150>
                                            &nbsp;
                                        </td>

                                        <td align=left width=250>
                                            <span lang=sv style='font-size: 10.0pt;font-family:Calibri;language:sv'>
                                                Körsträcka: {{.DistanceString}} km<br>
                                                Tid: {{.DurationString}}
                                            </span>
                                        </td>

                                        <td class={{.ClassificationClass}} align=right width=150>
                                            {{.ClassificationString}}
                                        </td>
                                    </tr>

                                    <tr height=10>
                                        <td colspan=7>
                                            &nbsp;
                                        </td>
                                    </tr>
                                    {{end}}
                                    {{end}}
                                </table>
                            </td>
                        </tr>

                        <tr height=10>
                            <td colspan=3>
                                &nbsp;
                            </td>
                        </tr>
                        {{end}}
                    </table>
                </form>
            </div>
        </center>

<script>
function reloadPage() {
    window.location = window.location.href;
}

$(document).ready(function() {
    $(".day").hover(
        function() {
        },
        function() {
        }
    );

    $(".day").click(
        function() {
        }
    );

    $(".mastercb").click(
        function() {
            var checked = this.checked;
            $(this).parents(".day").find(":checkbox").not(this).each(
                function() {
                    this.checked = checked;
                }
            );

            checkedDrivesChanged();
        }
    );

    $(".drivecb").click(
        function() {
            if (!this.checked) {
                $(this).parents(".day").find(".mastercb").each(
                    function() {
                        this.checked = false;
                    }
                );
            }

            checkedDrivesChanged();
        }
    );

    var frm = $("#dayform");
    frm.submit(function (e) {
        e.preventDefault();

        $.ajax({
            type: frm.attr("method"),
            url: frm.attr("action"),
            data: frm.serialize(),
            success: function (data) {
                var json = JSON.parse(data);

                populateTotals(json.Totals);
                populateDays(json.AffectedDays);
            },
            error: function (data) {
                console.log('An error occurred.');
                console.log(data);
            },
        });
    });

    function checkedDrivesChanged() {
        var checkedGroupDrives = $(".groupedcb:checked").length;
        var checkedDrives = $(".drivecb:checked").not(".groupedcb").length;
        var nothingChecked = checkedDrives == 0 && checkedGroupDrives == 0;

        $("#btn_business").prop("disabled", nothingChecked);
        $("#btn_private").prop("disabled", nothingChecked);
        $("#btn_group").prop("disabled", nothingChecked || checkedDrives < 2  || checkedGroupDrives > 0);
        $("#btn_ungroup").prop("disabled", nothingChecked || checkedDrives > 0 || checkedGroupDrives == 0);
    }

    $("#btn_business").click(
        function() {
            $("#action").val("classify");
            $("#classification").val("business");

            $("#dayform").submit();
        }
    );

    $("#btn_private").click(
        function() {
            $("#action").val("classify");
            $("#classification").val("private");

            $("#dayform").submit();
        }
    );

    $("#btn_group").click(
        function() {
            $("#action").val("group");

            $("#dayform").submit();
        }
    );

    $("#btn_ungroup").click(
        function() {
            $("#action").val("ungroup");

            $("#dayform").submit();
        }
    );

    function populateTotals(totals) {
        var html = "";
        html += "Total körsträcka: " + totals.TotalDistance.toFixed(1) + " km<br>";
        html += "Varav tjänsteresor: " + totals.TotalBusinessDistance.toFixed(1) + " km<br>";
        html += "Varav privatresor: " + totals.TotalPrivateDistance.toFixed(1) + " km";
        if (totals.UnclassifiedDistance > 0) {
            html += "<br><font color='red'>Oklassificerad sträcka: " + totals.UnclassifiedDistance.toFixed(1) + " km</font>";
        }

        $("#totaldistances").html(html);

        html = "";
        html += "Total tid: " + tohhmm(totals.TotalDuration) + "<br>";
        html += "Varav tjänsteresor: " + tohhmm(totals.TotalBusinessDuration) + "<br>";
        html += "Varav privatresor: " + tohhmm(totals.TotalPrivateDuration);
        if (totals.UnclassifiedDuration > 0) {
            html += "<br><font color='red'>Oklassificerad tid: " + tohhmm(totals.UnclassifiedDuration) + "</font>";
        }

        $("#totaldurations").html(html);
    }

    function tohhmm(minutes) {
        var mm = minutes;
        var hh = 0;

        while (mm >= 60) {
            hh += 1;
            mm -= 60;
        }

        return hh + ":" + (mm).toLocaleString(undefined, {minimumIntegerDigits: 2});
    }

    function populateDays(days) {
        $.each(days,
            function(i, day) {
                populateDay(day);
            }
        );
    }

    function populateDay(day) {
        var html = "";

        html += "<tr height=10>";
        html += "<td align=left width=25>";
        html += "    <input type='checkbox' class='mastercb'/>";
        html += "</td>";

        html += "<td width=25>";
        html += "    &nbsp;";
        html += "</td>";

        html += "<td align=left colspan=5>";
        html += "    <span class='date'>" + day.DateString + "</span>";
        html += "</td>";
        html += "</tr>";

        html += "<tr height=10>";
        html += "<td colspan=7>";
        html += "&nbsp;";
        html += "</td>";
        html += "</tr>";

        html += makeDrivesHTML(day.Drives, day.GroupedDrives);

        $("#day_" + day.DateAsTs).html(html);
    }

    function makeDrivesHTML(drives, groupedDrives) {
        var html = "";

        var currentGroupId = -1
        $.each(drives,
            function(i, drive) {
                var gid = drive.GroupId.Valid ? drive.GroupId.Int32 : -1;

                if (gid != -1 && gid != currentGroupId) {
                    currentGroupId = gid;

                    html += makeDriveHTML(getGroupedDrive(groupedDrives, gid), gid);
                }

                if (gid == -1) {
                    html += makeDriveHTML(drive);
                }
            }
        );

        return html;
    }

    function makeDriveHTML(drive, groupID = -1) {
        var html = "";

        html += "<tr>";
        html += "<td align=left valign=center width=25>";
        if (groupID != -1) {
            html += "<input type='checkbox' class='drivecb groupedcb' name='groupeddrive' value='" + groupID + "'/>";
        } else {
            html += "    <input type='checkbox' class='drivecb' name='drive' value='" + drive.Id + "'/>";
        }
        html += "</td>";

        html += "<td align=center valign=center width=25>";
        if (groupID != -1) {
            html += "<svg width='24' height='30'>";
            html += "<use x='0' y='0' xlink:href='#merge'/>";
            html += "</svg>";
        } else {
            html += "    &nbsp;";
        }
        html += "</td>";

        html += "<td align=left width=250>";
        html += "    <span lang=sv style='font-size: 10.0pt; font-family:Calibri;language:sv'>";
        html += "    " + drive.EndAddress + "<br>";
        html += "    " + drive.StartAddress;
        html += "    </span>";
        html += "</td>";

        html += "<td align=right width=50>";
        html += "    <span lang=sv style='font-size: 10.0pt;font-family:Calibri;language:sv'>";
        html += "    " + drive.EndTime + "<br>";
        html += "    " + drive.StartTime;
        html += "    </span>";
        html += "</td>";

        html += "<td width=150>";
        html += "    &nbsp;";
        html += "</td>";

        html += "<td align=left width=250>";
        html += "    <span lang=sv style='font-size: 10.0pt;font-family:Calibri;language:sv'>";
        html += "    Körsträcka: " + drive.DistanceString + " km<br>";
        html += "    Tid: " + drive.DurationString;
        html += "    </span>";
        html += "</td>";

        html += "<td class=" + drive.ClassificationClass + " align=right width=150>";
        html += "    " + drive.ClassificationString;
        html += "</td>";
        html += "</tr>";

        html += "<tr height=10>";
        html += "<td colspan=7>";
        html += "&nbsp;";
        html += "</td>";
        html += "</tr>";

        return html;
    }

    function getGroupedDrive(groupedDrives, gid) {
        for (var i = 0; i < groupedDrives.length; i++) {
           if (groupedDrives[i].Id == gid) {
              return groupedDrives[i];
           }
        }

        return null;
    }

});
</script>
    </body>
</html>

